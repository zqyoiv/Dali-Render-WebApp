<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dali Render WebApp</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .input-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        label {
            font-weight: bold;
            min-width: 100px;
        }
        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            width: 100px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result-section {
            margin-top: 20px;
            padding: 20px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .garden-state {
            margin-top: 15px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
            font-family: monospace;
        }
        .garden-monitor-section {
            margin: 20px 0;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 5px;
            border: 1px solid #b3d9ff;
        }
        .monitor-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .auto-refresh label {
            font-weight: normal;
            font-size: 14px;
            color: #666;
            cursor: pointer;
        }
        .auto-refresh input[type="checkbox"] {
            margin: 0;
        }
        .last-update {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            font-style: italic;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå± Dali Dream Garden</h1>
        
        <div class="input-section">
            <div class="input-group">
                <label for="objectId">Object ID:</label>
                <input type="number" id="objectId" min="1" max="30" placeholder="1-30">
                <button id="submitBtn" onclick="addObject()">Add Object</button>
            </div>
            <small>Enter an object ID (1-30) to add to the garden</small>
        </div>
        
        <div class="input-section" style="background: #fff3cd; border: 1px solid #ffc107;">
            <h3>üåø Set Entire Garden (Test Cases)</h3>
            <p style="font-size: 14px; margin-bottom: 15px;">
                Test batch adding objects via OSC. Select a predefined test case or create a custom array.
            </p>
            
            <div class="input-group">
                <label for="testCase">Test Case:</label>
                <select id="testCase" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                    <option value="small">Small Garden (5 objects)</option>
                    <option value="medium">Medium Garden (12 objects)</option>
                    <option value="large">Large Garden (18 objects)</option>
                    <option value="full">Full Garden (22 objects)</option>
                    <option value="diverse">Diverse Mix (15 objects)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="clearFirst" checked>
                    <span style="font-weight: normal; font-size: 14px;">Clear garden before adding</span>
                </label>
            </div>
            
            <div class="input-group">
                <button id="setGardenBtn" onclick="setEntireGarden()" style="background-color: #28a745;">
                    üå± Set Entire Garden
                </button>
                <button onclick="showTestCaseDetails()" style="background-color: #6c757d;">
                    ‚ÑπÔ∏è View Details
                </button>
            </div>
        </div>
        
        <div class="garden-monitor-section">
            <h3>üåø Garden Monitor</h3>
            <div class="monitor-controls">
                <button id="updateGardenBtn" onclick="updateGardenState()">Update Garden State</button>
                <button id="initGardenBtn" onclick="initGarden()" style="background-color: #17a2b8;">üå± Init Garden</button>
                <button id="clearGardenBtn" onclick="clearGarden()" style="background-color: #dc3545;">üßπ Clear Garden</button>
                <div class="auto-refresh">
                    <label>
                        <input type="checkbox" id="autoRefreshCheckbox" checked> Auto-refresh every 30s
                    </label>
                </div>
            </div>
            <div id="gardenMonitorState" class="garden-state">
                <div id="gardenMonitorContent">Loading garden state...</div>
            </div>
            <div id="lastUpdate" class="last-update"></div>
        </div>
        
        <div id="resultSection" class="result-section hidden">
            <div id="message"></div>
            <div id="gardenState" class="garden-state hidden">
                <h4>Current Garden State:</h4>
                <div id="gardenContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Test case definitions - diverse objects that fit location requirements
        const TEST_CASES = {
            small: {
                name: "Small Garden",
                description: "5 diverse objects to test basic functionality",
                objectIds: [1, 3, 6, 8, 10]
            },
            medium: {
                name: "Medium Garden",
                description: "12 objects with varied placement types",
                objectIds: [1, 2, 3, 5, 7, 10, 13, 15, 18, 20, 22, 25]
            },
            large: {
                name: "Large Garden",
                description: "18 objects filling most of the garden",
                objectIds: [1, 2, 3, 4, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 30]
            },
            full: {
                name: "Full Garden",
                description: "22 objects (maximum capacity)",
                objectIds: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22]
            },
            diverse: {
                name: "Diverse Mix",
                description: "15 objects covering all location types (M, B, RM, RC, H)",
                objectIds: [1, 3, 6, 7, 10, 11, 14, 17, 19, 21, 23, 24, 26, 28, 30]
            }
        };
        
        async function setEntireGarden() {
            const testCaseKey = document.getElementById('testCase').value;
            const clearFirst = document.getElementById('clearFirst').checked;
            const setGardenBtn = document.getElementById('setGardenBtn');
            const resultSection = document.getElementById('resultSection');
            
            const testCase = TEST_CASES[testCaseKey];
            
            if (!testCase) {
                showResult('Invalid test case selected', 'error');
                return;
            }
            
            // Disable button during request
            setGardenBtn.disabled = true;
            setGardenBtn.textContent = 'üå± Setting Garden...';
            
            try {
                console.log(`Setting garden with test case: ${testCase.name}`);
                console.log(`Objects to add: [${testCase.objectIds.join(', ')}]`);
                
                const response = await fetch('/set-garden', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        clearFirst: clearFirst,
                        objectIds: testCase.objectIds
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const summaryMsg = `${testCase.name}: ${data.message}`;
                    showResult(summaryMsg, 'success');
                    displayBatchGardenState(data);
                    
                    // Update the garden monitor
                    setTimeout(() => updateGardenState(), 500);
                } else {
                    showResult(`Failed: ${data.message}`, 'error');
                }
                
            } catch (error) {
                showResult('Error connecting to server: ' + error.message, 'error');
            } finally {
                // Re-enable button
                setGardenBtn.disabled = false;
                setGardenBtn.textContent = 'üå± Set Entire Garden';
            }
        }
        
        function displayBatchGardenState(data) {
            const gardenState = document.getElementById('gardenState');
            const gardenContent = document.getElementById('gardenContent');
            
            const objectsInfo = data.gardenState.objects.map((objId, index) => 
                `Object ${objId} ‚Üí ${data.gardenState.locations[index]}`
            ).join('<br>');
            
            let changesHtml = '<br><strong>Batch Operation Details:</strong><br>';
            changesHtml += `Total Objects: ${data.summary.total}<br>`;
            changesHtml += `Successfully Added: ${data.summary.successful}<br>`;
            changesHtml += `Failed: ${data.summary.failed}<br><br>`;
            
            // Display OSC Array that was sent
            if (data.oscData && data.oscData.sent) {
                changesHtml += '<div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin: 10px 0; border: 1px solid #2196f3;">';
                changesHtml += `<strong style="color: #1976d2;">üì§ OSC Array Sent:</strong><br>`;
                changesHtml += `<strong>Address:</strong> ${data.oscData.address}<br>`;
                changesHtml += `<strong>Count:</strong> ${data.oscData.count} objects<br>`;
                changesHtml += '<strong>Array Data:</strong><br>';
                changesHtml += '<div style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #fff; padding: 8px; border-radius: 3px; margin-top: 5px;">';
                changesHtml += '<pre style="margin: 0;">' + JSON.stringify(data.oscData.array, null, 2) + '</pre>';
                changesHtml += '</div>';
                changesHtml += '</div><br>';
            }
            
            if (data.addedObjects && data.addedObjects.length > 0) {
                changesHtml += '<strong>Added Objects:</strong><br>';
                data.addedObjects.forEach(obj => {
                    changesHtml += `<span style="color: #28a745;">‚ûï ${obj.id} (${obj.name}) ‚Üí ${obj.location}</span><br>`;
                });
            }
            
            if (data.removedObjects && data.removedObjects.length > 0) {
                changesHtml += '<br><strong>Removed Objects:</strong><br>';
                data.removedObjects.forEach(obj => {
                    const reasonText = obj.reason ? ` (${obj.reason})` : '';
                    changesHtml += `<span style="color: #dc3545;">‚ûñ ${obj.id} (${obj.name}) from ${obj.location}${reasonText}</span><br>`;
                });
            }
            
            // Display timestamps if available
            let timestampsHtml = '';
            if (data.gardenState.objectTimestamps && Object.keys(data.gardenState.objectTimestamps).length > 0) {
                timestampsHtml = '<br><strong>Object Timestamps:</strong><br>';
                for (const [objId, timestamp] of Object.entries(data.gardenState.objectTimestamps)) {
                    const date = new Date(timestamp);
                    timestampsHtml += `<small>Object ${objId}: ${date.toLocaleTimeString()}</small><br>`;
                }
            }
            
            gardenContent.innerHTML = `
                <strong>Final Garden State:</strong><br>
                <strong>Objects:</strong> [${data.gardenState.objects.join(', ')}] (${data.gardenState.objects.length}/22)<br>
                <strong>Locations:</strong> [${data.gardenState.locations.join(', ')}]<br>
                <strong>Adding Order:</strong> [${data.gardenState.addingOrder.join(', ')}] (oldest ‚Üí newest)<br><br>
                <strong>Placements:</strong><br>
                ${objectsInfo || 'No objects in garden'}
                ${timestampsHtml}
                ${changesHtml}
            `;
            
            gardenState.classList.remove('hidden');
        }
        
        function showTestCaseDetails() {
            const testCaseKey = document.getElementById('testCase').value;
            const testCase = TEST_CASES[testCaseKey];
            
            if (!testCase) {
                alert('No test case selected');
                return;
            }
            
            const details = `Test Case: ${testCase.name}\n\n` +
                          `Description: ${testCase.description}\n\n` +
                          `Number of Objects: ${testCase.objectIds.length}\n\n` +
                          `Object IDs: [${testCase.objectIds.join(', ')}]`;
            
            alert(details);
        }
        
        async function addObject() {
            const objectId = document.getElementById('objectId').value;
            const submitBtn = document.getElementById('submitBtn');
            const resultSection = document.getElementById('resultSection');
            const message = document.getElementById('message');
            const gardenState = document.getElementById('gardenState');
            const gardenContent = document.getElementById('gardenContent');
            
            // Validate input
            if (!objectId || objectId < 1 || objectId > 30) {
                showResult('Please enter a valid object ID (1-30)', 'error');
                return;
            }
            
            // Disable button during request
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';
            
            try {
                const response = await fetch(`/add/${objectId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult(data.message, 'success');
                    displayGardenState(data.gardenState);
                    displayObjectChanges(data.removedObject, data.addedObject);
                    
                    // Update the garden monitor to keep it in sync
                    setTimeout(() => updateGardenState(), 500);
                } else {
                    showResult(data.message, 'error');
                    gardenState.classList.add('hidden');
                }
                
            } catch (error) {
                showResult('Error connecting to server: ' + error.message, 'error');
                gardenState.classList.add('hidden');
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Object';
            }
        }
        
        function showResult(msg, type) {
            const resultSection = document.getElementById('resultSection');
            const message = document.getElementById('message');
            
            message.textContent = msg;
            resultSection.className = `result-section ${type}`;
            resultSection.classList.remove('hidden');
        }
        
        function displayGardenState(state) {
            const gardenState = document.getElementById('gardenState');
            const gardenContent = document.getElementById('gardenContent');
            
            const objectsInfo = state.objects.map((objId, index) => 
                `Object ${objId} ‚Üí ${state.locations[index]}`
            ).join('<br>');
            
            const lastModifiedDate = state.lastModified ? new Date(state.lastModified).toLocaleString() : 'Unknown';
            const stateInfo = state.stateVersion ? 
                `<div style="background: #fff3cd; padding: 6px; border-radius: 3px; margin-bottom: 8px; font-size: 12px;">
                    <strong>State Version:</strong> ${state.stateVersion} | <strong>Last Modified:</strong> ${lastModifiedDate}
                </div>` : '';
            
            // Display timestamps if available
            let timestampsHtml = '';
            if (state.objectTimestamps && Object.keys(state.objectTimestamps).length > 0) {
                timestampsHtml = '<br><strong>Object Timestamps:</strong><br>';
                for (const [objId, timestamp] of Object.entries(state.objectTimestamps)) {
                    const date = new Date(timestamp);
                    timestampsHtml += `<small>Object ${objId}: ${date.toLocaleTimeString()}</small><br>`;
                }
            }
            
            gardenContent.innerHTML = `
                ${stateInfo}
                <strong>Objects:</strong> [${state.objects.join(', ')}] (${state.objects.length}/22)<br>
                <strong>Locations:</strong> [${state.locations.join(', ')}]<br>
                <strong>Adding Order:</strong> [${state.addingOrder.join(', ')}] (oldest ‚Üí newest)<br><br>
                <strong>Placements:</strong><br>
                ${objectsInfo || 'No objects in garden'}
                ${timestampsHtml}
            `;
            
            gardenState.classList.remove('hidden');
        }
        
        function displayObjectChanges(removedObject, addedObject) {
            const gardenContent = document.getElementById('gardenContent');
            let changesHtml = '<br><strong>Changes:</strong><br>';
            
            if (removedObject) {
                let removeReason = '';
                let removeColor = '#dc3545;'; // default red
                if (removedObject.reason === 'duplicate') {
                    removeReason = ' (duplicate)';
                } else if (removedObject.reason === 'oldest') {
                    removeReason = ' (oldest in garden)';
                } else if (removedObject.reason === 'forced_displacement') {
                    removeReason = ' (forcibly displaced)';
                    removeColor = '#ff6b35;'; // orange for forced displacement
                }
                changesHtml += `<span style="color: ${removeColor}">‚ûñ Removed: Object ${removedObject.id} (${removedObject.name}) from ${removedObject.location}${removeReason}</span><br>`;
            }
            
            if (addedObject) {
                changesHtml += `<span style="color: #28a745;">‚ûï Added: Object ${addedObject.id} (${addedObject.name}) to ${addedObject.location}</span><br>`;
            }
            
            gardenContent.innerHTML += changesHtml;
        }
        
        // Allow Enter key to submit
        document.getElementById('objectId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addObject();
            }
        });
        
        async function initGarden() {
            const initBtn = document.getElementById('initGardenBtn');
            
            if (!confirm('Initialize the garden? This will clear all objects and add 6 default objects (same as startup).')) {
                return;
            }
            
            // Disable button during request
            initBtn.disabled = true;
            initBtn.textContent = 'üå± Initializing...';
            
            try {
                const response = await fetch('/init-garden', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult(data.message + ' (6 default objects)', 'success');
                    
                    // Update both garden displays
                    setTimeout(() => updateGardenState(), 500);
                    
                    const gardenState = document.getElementById('gardenState');
                    gardenState.classList.add('hidden');
                } else {
                    showResult(`Failed: ${data.message}`, 'error');
                }
                
            } catch (error) {
                showResult('Error connecting to server: ' + error.message, 'error');
            } finally {
                // Re-enable button
                initBtn.disabled = false;
                initBtn.textContent = 'üå± Init Garden';
            }
        }
        
        async function clearGarden() {
            const clearBtn = document.getElementById('clearGardenBtn');
            
            if (!confirm('Are you sure you want to clear the entire garden? This will remove all objects.')) {
                return;
            }
            
            // Disable button during request
            clearBtn.disabled = true;
            clearBtn.textContent = 'üßπ Clearing...';
            
            try {
                const response = await fetch('/clear-garden', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult(data.message, 'success');
                    
                    // Update the garden monitor to keep it in sync
                    setTimeout(() => updateGardenState(), 500);
                    
                    const gardenState = document.getElementById('gardenState');
                    gardenState.classList.add('hidden');
                } else {
                    showResult(`Failed: ${data.message}`, 'error');
                }
                
            } catch (error) {
                showResult('Error connecting to server: ' + error.message, 'error');
            } finally {
                // Re-enable button
                clearBtn.disabled = false;
                clearBtn.textContent = 'üßπ Clear Garden';
            }
        }
        
        // Garden Monitor functionality
        let autoRefreshInterval = null;
        
        async function updateGardenState() {
            const updateBtn = document.getElementById('updateGardenBtn');
            const gardenContent = document.getElementById('gardenMonitorContent');
            const lastUpdate = document.getElementById('lastUpdate');
            
            // Disable button during request
            updateBtn.disabled = true;
            updateBtn.textContent = 'Updating...';
            
            try {
                const response = await fetch('/garden-state');
                const data = await response.json();
                
                if (data.success) {
                    displayGardenMonitorState(data.gardenState);
                    lastUpdate.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                } else {
                    gardenContent.innerHTML = `<span style="color: #dc3545;">Error: ${data.message}</span>`;
                }
                
            } catch (error) {
                gardenContent.innerHTML = `<span style="color: #dc3545;">Error connecting to server: ${error.message}</span>`;
            } finally {
                // Re-enable button
                updateBtn.disabled = false;
                updateBtn.textContent = 'Update Garden State';
            }
        }
        
        function displayGardenMonitorState(state) {
            const gardenContent = document.getElementById('gardenMonitorContent');
            
            const objectsInfo = state.objects.map((objId, index) => 
                `Object ${objId} ‚Üí ${state.locations[index]}`
            ).join('<br>');
            
            const lastModifiedDate = state.lastModified ? new Date(state.lastModified).toLocaleString() : 'Unknown';
            
            // Display timestamps if available
            let timestampsHtml = '';
            if (state.objectTimestamps && Object.keys(state.objectTimestamps).length > 0) {
                timestampsHtml = '<br><strong>Object Timestamps:</strong><br>';
                for (const [objId, timestamp] of Object.entries(state.objectTimestamps)) {
                    const date = new Date(timestamp);
                    timestampsHtml += `<small>Object ${objId}: ${date.toLocaleTimeString()}</small><br>`;
                }
            }
            
            gardenContent.innerHTML = `
                <div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin-bottom: 10px; border: 1px solid #ffc107;">
                    <strong>üîí Singleton Garden State</strong><br>
                    <small>Version: ${state.stateVersion || 0} | Last Modified: ${lastModifiedDate}</small>
                </div>
                <strong>Objects:</strong> [${state.objects.join(', ')}] (${state.objects.length}/22)<br>
                <strong>Locations:</strong> [${state.locations.join(', ')}]<br>
                <strong>Adding Order:</strong> [${state.addingOrder.join(', ')}] (oldest ‚Üí newest)<br><br>
                <strong>Placements:</strong><br>
                ${objectsInfo || 'No objects in garden'}
                ${timestampsHtml}
            `;
        }
        
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            const checkbox = document.getElementById('autoRefreshCheckbox');
            if (checkbox.checked) {
                // Update immediately and then every 30 seconds
                updateGardenState();
                autoRefreshInterval = setInterval(updateGardenState, 30000);
            }
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Event listeners
        document.getElementById('autoRefreshCheckbox').addEventListener('change', function() {
            if (this.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });
        
        // Initialize auto-refresh on page load
        window.addEventListener('load', function() {
            startAutoRefresh();
        });
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
</body>
</html>
